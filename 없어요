import streamlit as st
from ollama import chat
import re

def convertToInitialLetters(text):
    CHOSUNG_START_LETTER = 4352
    JAMO_START_LETTER = 44032
    JAMO_END_LETTER = 55203
    JAMO_CYCLE = 588

    def isHangul(ch):
        return ord(ch) >= JAMO_START_LETTER and ord(ch) <= JAMO_END_LETTER
    
    result = ""
    for ch in text:
        if isHangul(ch):
            result += unichr((ord(ch) - JAMO_START_LETTER) / JAMO_CYCLE + CHOSUNG_START_LETTER)
    
    return result

# ê³µë°±ê³¼ íŠ¹ìˆ˜ë¬¸ìžë¥¼ ì œê±°í•˜ì—¬ ì •ê·œí™”
def normalize_text(text):
    return re.sub(r"[\s\W_]+", "", text)

# ëª¨ë“  ëŒ€í™” ê¸°ë¡ì—ì„œ ì¤‘ë³µì„ ê²€ì‚¬í•˜ëŠ” í•¨ìˆ˜ (ì‚¬ìš©ìž + ì±—ë´‡ ëª¨ë‘)
def is_duplicate(word):
    normalized_word = normalize_text(word)
    return any(normalize_text(msg['content']) == normalized_word for msg in st.session_state.messages)

# set page info
st.set_page_config(page_title='Test')
st.title("My Personal Assistant")

# create chat history
if "messages" not in st.session_state:
    st.session_state.messages = []

# ëŒ€í™” ê¸°ë¡ í‘œì‹œ (ì‚¬ìš©ìžì™€ ì±—ë´‡ êµ¬ë¶„)
st.header("ðŸ“œ ëŒ€í™” ê¸°ë¡")
for message in st.session_state.messages:
    role = "User" if message['role'] == 'user' else "PlayerBot"
    with st.chat_message(message['role']):
        st.markdown(f"**{role}:** {message['content']}")

# accept user input
if prompt := st.chat_input("Please Write the word"):
    # ì¤‘ë³µ ê²€ì‚¬ (ì‚¬ìš©ìžì™€ ì±—ë´‡ì˜ ëª¨ë“  ê¸°ë¡ ê²€ì‚¬)
    if is_duplicate(prompt):
        st.warning("ì´ë¯¸ ì‚¬ìš©í•œ ë‹¨ì–´ìž…ë‹ˆë‹¤. ë‹¤ë¥¸ ë‹¨ì–´ë¥¼ ìž…ë ¥í•˜ì„¸ìš”.")
    else:
        # ì‚¬ìš©ìž ë°œì–¸ ì¶”ê°€
        st.session_state.messages.append({'role': 'user', 'content': prompt})
        with st.chat_message("user"):
            st.markdown(f"**User:** {prompt}")

        # ì±—ë´‡ ì‘ë‹µ ìƒì„± ë° ì¤‘ë³µ ê²€ì‚¬
        with st.chat_message("PlayerBot"):
            placeholder = st.empty()
            response = ""

            while True:
                # ëŒ€í™” ê¸°ë¡ì„ êµëŒ€ë¡œ ë„£ì–´ì„œ ì±—ë´‡ì—ê²Œ ì „ë‹¬
                chat_history = [
                    {"role": "system", "content": (
                        "ë„ˆëŠ” ëë§ìž‡ê¸° ì „ë¬¸ê°€ì•¼. ì‚¬ìš©ìžê°€ ì œì‹œí•œ ë§ˆì§€ë§‰ ê¸€ìžë¡œ ì‹œìž‘í•˜ëŠ” ë‹¨ì–´ë¥¼ ì œì‹œí•´. "
                        "í•­ìƒ ì‚¬ìš©ìžê°€ ë§ˆì§€ë§‰ìœ¼ë¡œ ìž…ë ¥í•œ ë‹¨ì–´ì˜ ë§ˆì§€ë§‰ ê¸€ìžë¡œ ì‹œìž‘í•˜ëŠ” ë‹¨ì–´ë¥¼ ì œì‹œí•´ì•¼ í•´. "
                        "ì „ì— ì‚¬ìš©í–ˆë˜ ë‹¨ì–´ë¥¼ ì‚¬ìš©í•´ì„œëŠ” ì•ˆ ë¼. "
                        "ì˜ˆì‹œ: 'ê°•ì•„ì§€' â†’ 'ì§€ê°‘', 'ê³ ì–‘ì´' â†’ 'ì´ë°œì†Œ'. "
                        "ì¤‘ë³µë˜ëŠ” ë‹¨ì–´ëŠ” ì‚¬ìš©í•˜ë©´ ì•ˆ ë¼. ë˜ í•œ ê¸€ìž ë‹¨ì–´ë„ ì•ˆ ë¼. "
                        "ë°˜ë“œì‹œ ì‚¬ìš©ìžì˜ ë§ˆì§€ë§‰ ê¸€ìžì— ì§‘ì¤‘í•´ì„œ ë‹µë³€í•´. í•œ ê¸€ìžë¡œ ë‹µí•˜ë©´ ê·œì¹™ì„ ì–´ê¸´ ê±°ì•¼. "
                        "í•œêµ­ì–´ë¡œë§Œ ëŒ€ë‹µí•˜ê³ , ë‘ ê¸€ìž ì´ìƒì˜ í•œ ë‹¨ì–´ë¡œë§Œ ë‹µí•´."
                    )}
                ]
                
                # ëŒ€í™” ê¸°ë¡ì„ ì‚¬ìš©ìž-ì±—ë´‡ ìˆœìœ¼ë¡œ ì •ë¦¬í•˜ì—¬ ì „ë‹¬
                for msg in st.session_state.messages:
                    chat_history.append({"role": msg['role'], "content": msg['content']})

                # ì±—ë´‡ ì‘ë‹µ ìƒì„±
                stream = chat(
                    model='gemma3:12b',
                    messages=chat_history,
                    stream=True
                )

                response = ""
                for chunk in stream:
                    response += chunk.message.content
                    placeholder.markdown(f"**PlayerBot:** {response}")

                # ì±—ë´‡ ì‘ë‹µì„ ê¸°ë¡ì— ì¶”ê°€í•˜ì—¬ ì¤‘ë³µ ê²€ì‚¬ì— ë°˜ì˜
                st.session_state.messages.append({"role": "assistant", "content": response})

                # ì¤‘ë³µ ê²€ì‚¬
                if not is_duplicate(response):
                    break
                else:
                    st.warning("ì±—ë´‡ì´ ì¤‘ë³µëœ ë‹¨ì–´ë¥¼ ì œì‹œí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤.")
                    # ì¤‘ë³µëœ ì‘ë‹µì„ ê¸°ë¡ì—ì„œ ì œê±°
                    st.session_state.messages.pop()

        # ìµœì¢… ì‘ë‹µì„ ê¸°ë¡ì— ì¶”ê°€
        st.session_state.messages.append({"role": "assistant", "content": response})
